name: ğŸ” Debug Google to Notion Sync (Selenium)

on:
  workflow_dispatch:
    inputs:
      test_offset:
        description: "ì‹œì‘ ì˜¤í”„ì…‹"
        required: false
        default: "0"
      test_limit:
        description: "ì²˜ë¦¬ ê°œìˆ˜"
        required: false
        default: "2" # Selenium í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 2ê°œë¡œ ì œí•œ
  repository_dispatch:
    types: [run-sync]

jobs:
  debug-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Step 1 - Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Step 2 - SECRET ì™„ì „ ë””ë²„ê¹…
        run: |
          echo "ğŸ”ğŸ”ğŸ” SECRETS ë””ë²„ê¹… ì‹œì‘ ğŸ”ğŸ”ğŸ”"
          echo "í˜„ì¬ ì‹œê°„: $(date)"
          echo "ì›Œí¬í”Œë¡œìš°: debug-sync.yml"
          echo ""

          echo "=== Google JSON Secret ìƒíƒœ ==="
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "âŒâŒâŒ GOOGLE_APPLICATION_CREDENTIALS_JSONì´ ì™„ì „íˆ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… Secretì´ ì¡´ì¬í•©ë‹ˆë‹¤"
          echo "ê¸¸ì´: ${#GOOGLE_APPLICATION_CREDENTIALS_JSON} ë¬¸ì"

          if [ ${#GOOGLE_APPLICATION_CREDENTIALS_JSON} -lt 500 ]; then
            echo "âŒâŒâŒ JSONì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "=== ë‹¤ë¥¸ Secrets ìƒíƒœ ==="
          echo "SPREADSHEET_ID: ${SPREADSHEET_ID:-'âŒ ì—†ìŒ'}"
          echo "NOTION_TOKEN ê¸¸ì´: ${#NOTION_TOKEN}"
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-'âŒ ì—†ìŒ'}"

          echo "ğŸ”ğŸ”ğŸ” SECRET ë””ë²„ê¹… ì™„ë£Œ ğŸ”ğŸ”ğŸ”"
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

      - name: ğŸ” Step 3 - Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ” Step 4 - íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          echo "ğŸ” Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          pip install -r requirements.txt
          echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ” Step 5 - Chrome ë° Selenium í™˜ê²½ ì„¤ì •
        run: |
          echo "ğŸ”ğŸ”ğŸ” Chrome ë° Selenium í™˜ê²½ ì„¤ì • ì‹œì‘ ğŸ”ğŸ”ğŸ”"

          # Chrome ì„¤ì¹˜
          echo "Chrome ì„¤ì¹˜ ì¤‘..."
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

          # Chrome ë²„ì „ í™•ì¸
          echo "Chrome ë²„ì „ í™•ì¸:"
          google-chrome --version

          # Xvfb ì„¤ì¹˜ (ê°€ìƒ ë””ìŠ¤í”Œë ˆì´)
          echo "Xvfb ì„¤ì¹˜ ì¤‘..."
          sudo apt-get install -y xvfb

          # ë””ìŠ¤í”Œë ˆì´ ì„œë²„ ì‹œì‘
          echo "ê°€ìƒ ë””ìŠ¤í”Œë ˆì´ ì‹œì‘..."
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 3

          # ë””ìŠ¤í”Œë ˆì´ í™•ì¸
          echo "ë””ìŠ¤í”Œë ˆì´ í™•ì¸: $DISPLAY"

          # ChromeDriver í™•ì¸
          echo "ChromeDriver í™•ì¸..."
          python -c "
          import chromedriver_autoinstaller
          driver_path = chromedriver_autoinstaller.install()
          print(f'ChromeDriver ê²½ë¡œ: {driver_path}')
          "

          echo "ğŸ”ğŸ”ğŸ” Chrome ë° Selenium í™˜ê²½ ì„¤ì • ì™„ë£Œ ğŸ”ğŸ”ğŸ”"

      - name: ğŸ” Step 6 - Selenium ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”ğŸ”ğŸ” Selenium ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ğŸ”ğŸ”ğŸ”"

          export DISPLAY=:99

          python << 'EOF'
          import os
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.chrome.service import Service
          import chromedriver_autoinstaller

          print("=== Selenium í…ŒìŠ¤íŠ¸ ì‹œì‘ ===")

          try:
              # ChromeDriver ì„¤ì¹˜
              driver_path = chromedriver_autoinstaller.install()
              print(f"ChromeDriver ê²½ë¡œ: {driver_path}")

              # Chrome ì˜µì…˜ ì„¤ì •
              opts = Options()
              opts.binary_location = "/usr/bin/google-chrome"
              
              # GitHub Actions í™˜ê²½ìš© ì˜µì…˜
              opts.add_argument("--headless")
              opts.add_argument("--no-sandbox")
              opts.add_argument("--disable-dev-shm-usage")
              opts.add_argument("--disable-gpu")
              opts.add_argument("--remote-debugging-port=9222")
              opts.add_argument("--window-size=1920,1080")
              
              print("Chrome ì˜µì…˜ ì„¤ì • ì™„ë£Œ")

              # ì›¹ë“œë¼ì´ë²„ ìƒì„±
              service = Service(driver_path)
              driver = webdriver.Chrome(service=service, options=opts)
              print("âœ… ì›¹ë“œë¼ì´ë²„ ìƒì„± ì„±ê³µ!")

              # í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì ‘ì†
              print("Google í™ˆí˜ì´ì§€ ì ‘ì† í…ŒìŠ¤íŠ¸...")
              driver.get("https://www.google.com")
              print(f"í˜ì´ì§€ ì œëª©: {driver.title}")
              
              if "Google" in driver.title:
                  print("âœ… Google í˜ì´ì§€ ì ‘ì† ì„±ê³µ!")
              else:
                  print("âŒ Google í˜ì´ì§€ ì ‘ì† ì‹¤íŒ¨")

              # Smore ì‚¬ì´íŠ¸ ì ‘ì† í…ŒìŠ¤íŠ¸
              print("Smore ì‚¬ì´íŠ¸ ì ‘ì† í…ŒìŠ¤íŠ¸...")
              driver.get("https://smore.im")
              print(f"í˜ì´ì§€ ì œëª©: {driver.title}")
              print(f"í˜„ì¬ URL: {driver.current_url}")
              
              if "smore" in driver.current_url.lower():
                  print("âœ… Smore ì‚¬ì´íŠ¸ ì ‘ì† ì„±ê³µ!")
              else:
                  print("âŒ Smore ì‚¬ì´íŠ¸ ì ‘ì† ì‹¤íŒ¨")

              driver.quit()
              print("âœ… Selenium í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")

          except Exception as e:
              print(f"âŒ Selenium ì˜¤ë¥˜: {e}")
              import traceback
              print(f"ìƒì„¸ ì˜¤ë¥˜:\n{traceback.format_exc()}")
              raise

          EOF

          echo "ğŸ”ğŸ”ğŸ” Selenium ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ğŸ”ğŸ”ğŸ”"

      - name: ğŸ” Step 7 - Google ì¸ì¦ íŒŒì¼ ìƒì„±
        run: |
          echo "ğŸ”ğŸ”ğŸ” Google ì¸ì¦ íŒŒì¼ ìƒì„± ì‹œì‘ ğŸ”ğŸ”ğŸ”"

          cat > /tmp/google_credentials.json << 'EOF'
          ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          EOF

          echo "íŒŒì¼ ìƒì„± ì™„ë£Œ"
          file_size=$(wc -c < /tmp/google_credentials.json)
          echo "íŒŒì¼ í¬ê¸°: ${file_size} bytes"

          if [ $file_size -lt 100 ]; then
            echo "âŒâŒâŒ íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          # JSON ìœ íš¨ì„± ê²€ì‚¬
          if python -c "import json; json.load(open('/tmp/google_credentials.json'))" 2>/dev/null; then
            echo "âœ…âœ…âœ… ìœ íš¨í•œ JSON íŒŒì¼ì…ë‹ˆë‹¤!"
          else
            echo "âŒâŒâŒ ìœ íš¨í•˜ì§€ ì•Šì€ JSONì…ë‹ˆë‹¤!"
            exit 1
          fi

          echo "ğŸ”ğŸ”ğŸ” Google ì¸ì¦ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ ğŸ”ğŸ”ğŸ”"

      - name: ğŸš€ Step 8 - Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (Selenium ë””ë²„ê¹…)
        env:
          CHROME_BINARY: /usr/bin/google-chrome
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/google_credentials.json
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_RANGE: ${{ secrets.SHEET_RANGE }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SMORE_USER_DATA: ""
          SMORE_PROFILE: ""
          TEST_OFFSET: ${{ github.event.inputs.test_offset || github.event.client_payload.test_offset || '0' }}
          TEST_LIMIT: ${{ github.event.inputs.test_limit || github.event.client_payload.test_limit || '2' }}
          PYTHONUNBUFFERED: 1
        run: |
          echo "ğŸš€ğŸš€ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘ ğŸš€ğŸš€ğŸš€"
          echo "TEST_OFFSET: $TEST_OFFSET"
          echo "TEST_LIMIT: $TEST_LIMIT"
          echo "Google ì¸ì¦ íŒŒì¼: $GOOGLE_APPLICATION_CREDENTIALS"

          # ê°€ìƒ ë””ìŠ¤í”Œë ˆì´ ì„¤ì • (ë‹¤ì‹œ í™•ì¸)
          export DISPLAY=:99

          # Xvfbê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
          if pgrep Xvfb > /dev/null; then
              echo "âœ… Xvfbê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
          else
              echo "âš ï¸ Xvfb ì¬ì‹œì‘..."
              Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
              sleep 3
          fi

          echo "ğŸ” Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          python -u google-to-notion.py

          echo "âœ…âœ…âœ… ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ âœ…âœ…âœ…"
